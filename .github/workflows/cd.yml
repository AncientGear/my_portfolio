name: Deploy on K8S Cluster

on:
  workflow_run:
    workflows: ["Push Docker Image"]
    types:
      - completed
  
jobs:
  deploy:
    name: deploy to cluster
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      
      - name: Update image tag in deployment YAML
        run: |
          sed -i "s|image:.*|image: ${{ vars.DOCKER_REPOSITORY }}/${{ vars.DOCKER_PROJECT_NAME }}:${{ github.sha }}|g" .github/workflows/yaml/my-portfolio-deploy.yaml
      
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" > $HOME/.kube/config
      
      - name: Create Docker registry secret
        run: |
          kubectl delete secret regcred --ignore-not-found=true
          kubectl create secret docker-registry regcred \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username="${{ secrets.DOCKER_USERNAME }}" \
            --docker-password="${{ secrets.DOCKER_PASSWORD }}" \
            --docker-email="${{ secrets.DOCKER_EMAIL }}"
      
      - name: deploy to cluster
        run: kubectl apply -f .github/workflows/yaml/my-portfolio-deploy.yaml
      
      - name: verify deployment
        run: kubectl rollout status deployment/my-portfolio